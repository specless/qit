<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<script>

var visible = false;
var prevVisible = false;

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}
function check() {
	var visible = false;
	
	requestAnimationFrame(function() {
		visible = true;
	});

	if (prevVisible != visible) {

	} 

	setTimeout(function() {
		if (prevVisible !== visible) {
			
			window.parent.postMessage(
			    {
			        event_id: 'inview',
			        data: {
			            position: getParameterByName('position'),
			            value: visible
			        }
			    }, 
			    "*"
			);
		}
		prevVisible = visible;
		check();
	}, 50);
}

check();


// NOTE!!!!! The below might be a WAY better way to do this....

var hidden, visibilityChange; 
if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
  hidden = "hidden";
  visibilityChange = "visibilitychange";
} else if (typeof document.msHidden !== "undefined") {
  hidden = "msHidden";
  visibilityChange = "msvisibilitychange";
} else if (typeof document.webkitHidden !== "undefined") {
  hidden = "webkitHidden";
  visibilityChange = "webkitvisibilitychange";
}

function handleVisibilityChange() {
  if (document[hidden]) {
    console.log('Hidden:' + window.location.href);
  } else {
    console.log('Visible:' + window.location.href);
  }
}

document.addEventListener(visibilityChange, handleVisibilityChange, false);

</script> 
</head>

<body>
</body>
</html>